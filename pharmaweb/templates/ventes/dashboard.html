{% extends "ventes/base_ventes.html" %}

{% block ventes_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Tableau de Bord - Caisse</h1>

    <!-- Section Statistiques -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ stats.ventes_jour }}</h5>
                    <p class="card-text">Ventes aujourd'hui</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ stats.chiffre_jour|format_currency }} Fc</h5>
                    <p class="card-text">Chiffre d'affaires</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        {% if stats.top_produit %}
                        {{ stats.top_produit[0] }} ({{ stats.top_produit[1] }})
                        {% else %}
                        Aucun
                        {% endif %}
                    </h5>
                    <p class="card-text">Produit le plus vendu</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Colonne de vente -->
        <div class="col-lg-5">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-cash-register me-2"></i>
                    Nouvelle vente
                </div>
                <div class="card-body">
                    <!-- Barre de recherche -->
                    <form method="GET" class="mb-4">
                        <div class="input-group">
                            <input type="text" class="form-control" name="recherche" placeholder="Nom ou code CIP..."
                                value="{{ search_term }}">
                            <button type="submit" class="btn btn-outline-light">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Liste des médicaments -->
                    <div class="list-group mb-4" style="max-height: 300px; overflow-y: auto;">
                        {% for med in medicaments %}
                        <form method="POST" action="{{ url_for('views.nouvelle_vente', recherche=search_term) }}"
                            class="list-group-item list-group-item-action">
                            <input type="hidden" name="medicament_id" value="{{ med.id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ med.nom_commercial }}</strong>
                                    <div class="text-muted small">
                                        {{ med.code_cip }} | Stock: {{ med.stock_actuel }}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-primary rounded-pill me-2">
                                        {{ med.prix_vente }} Fc
                                    </span>
                                    <input type="number" name="quantite" value="1" min="1" max="{{ med.stock_actuel }}"
                                        class="form-control form-control-sm" style="width: 60px;">
                                </div>
                            </div>
                            <!-- <button type="submit" class="btn btn-sm btn-success mt-2 w-100">
                                <i class="fas fa-cart-plus"></i> Ajouter
                            </button> -->
                        </form>
                        {% else %}
                        <div class="list-group-item text-center text-muted">
                            Aucun médicament trouvé
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Panier actuel -->
                    <div class="card border-primary">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Panier</h5>
                        </div>
                        <div class="card-body">
                            {% if session.get('panier') %}
                            <ul class="list-group">
                                {% for item in session['panier'] %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ item.nom }}</strong>
                                        <span class="text-muted small">x {{ item.quantite }}</span>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary rounded-pill">
                                            {{ (item.prix * item.quantite)|format_currency }} Fc
                                        </span>
                                        <a href="{{ url_for('views.retirer_du_panier', index=loop.index0) }}"
                                            class="btn btn-sm btn-danger ms-2">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            <div class="d-flex justify-content-between mt-3 fs-5">
                                <strong>Total:</strong>
                                <strong>{{ session.get('total', 0)|format_currency }} Fc</strong>
                            </div>
                            {% else %}
                            <p class="text-muted text-center">Panier vide</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Finalisation -->
                    {% if session.get('panier') %}
                    <form method="POST" action="{{ url_for('views.nouvelle_vente') }}" class="mt-3">
                        <div class="mb-3">
                            <label class="form-label">Mode de paiement</label>
                            <select name="mode_paiement" class="form-select" required>
                                <option value="especes">Espèces</option>
                                <option value="carte">Carte bancaire</option>
                                <option value="cheque">Chèque</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-check-circle me-2"></i> Finaliser la vente
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Historique des ventes -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-history me-2"></i>
                    Dernières ventes aujourd'hui
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>N° Ticket</th>
                                    <th>Heure</th>
                                    <th>Montant</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vente in dernieres_ventes %}
                                <tr>
                                    <td>{{ vente.numero_ticket }}</td>
                                    <td>{{ vente.date_vente.strftime('%H:%M') }}</td>
                                    <td>{{ "%.2f"|format(vente.montant_total) }} Fc</td>
                                    <td>
                                        <a href="{{ url_for('views.detail_facture', vente_id=vente.id) }}"
                                            class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fas fa-print"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center">Aucune vente aujourd'hui</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<script>
    // Dans votre block scripts
    let timeoutId;

    function rechercherMedicaments(term) {
        clearTimeout(timeoutId);

        timeoutId = setTimeout(() => {
            if (term.length === 0) term = " ";

            fetch(`/ventes/recherche-medicaments?q=${encodeURIComponent(term)}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('liste-medicaments').innerHTML = html;
                });
        }, 300); // Délai de 300ms après la dernière frappe
    }
</script>